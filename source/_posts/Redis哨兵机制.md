---
title: Redis哨兵机制
date: 2021-01-06 20:07:59
categories: 数据存储
tags:
top:
---
# 哨兵机制

主从库的集群模式使得当从库发生故障以后，客户端可以继续向主库或者其他从库发送请求，进行相关的操作；但是如果主库发生了故障，那会直接影响到从库的同步。无论是写中断还是从库无法进行数据同步都是Redis所不能接受的。因此我们需要一些机制，来能够将一个从库切换为主库，这就涉及到了Redis的哨兵机制。

# 1. 哨兵机制的基本流程

- 哨兵可以理解为一个运行在特殊模式下的Redis进程，其在主从库实例运行的同时也在运行
- 哨兵主要的三个任务为：
    - 监控 — 决策：判断主库是否处于下线状态
        - 周期性的ping主库，检测其是否仍然在线运行
        - 如果从库没有在规定时间内响应哨兵的Ping命令，哨兵就会将其标记为下线状态
        - 对主库来说同理，在判定主库下线以后会开始一个自动切换主库的流程
    - 选主 — 决策：决定选择哪个从库实例作为主库
        - 主库挂了以后，哨兵就需要从很多歌从库里按照一定的规则选择一个从库实例，将其作为新的主库
    - 通知
        - 将新主库的连接信息发给其他从库，让它们执行replicaof命令，与新主库建立连接，并进行数据复制
        - 哨兵会将新主库的连接信息通知给客户端，让它们将请求操作发到新主库当中

![哨兵三大任务](https://i.loli.net/2021/01/07/z7o6Kkdfp2IaPsx.png)

# 2. 判断主库的下线状态

## 2.1 哨兵集群

### 2.1.1 为什么需要哨兵集群？

- 如果哨兵发生误判，后续的选主和通知操作都会带来额外的计算和通信的开销
- 误判通常发生在
    - 集群网络压力较大
    - 网络拥塞
    - 主库本身压力较大的情况
- 哨兵机制也是类似的，它通常会采用多实例组成的集群模式进行部署，这也被称为哨兵集群。引入多个哨兵实例一起来判断，就可以避免单个哨兵因为自身网络状况不好，而误判主库下线的情况。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低。

### 2.1.2 如何使用哨兵集群？

- 简单来说，“客观下线”的标准就是，当有 N 个哨兵实例时，最好要有 N/2 + 1 个实例判断主库为“主观下线”，才能最终判定主库为“客观下线”。这样一来，就可以减少误判的概率，也能避免误判带来的无谓的主从库切换。（当然，有多少个实例做出“主观下线”的判断才可以，可以由 Redis 管理员自行设定）。

# 3. 如何选定新主库？

- 筛选
    - 确保从库仍然在线运行
    - 判断其之前的网络状态 看该从库和主库之间是否经常断联，出现网络相关的问题
- 打分 — 只要有得分最高的，那么就在当前轮停止并且认定其为主库
    - 从库优先级
        - 用户可以通过slave-priority配置项，给不同的从库设置不同的优先级
            - 譬如：两个从库内存大小不一样，我们就可以手动给内存大的实例设置一个高优先级
    - 从库复制进度
        - 选择和旧主库同步最为接近的那个从库作为主库
        - 如何判断从库和旧主库的同步进度？
            - 主从库之间命令传播机制里面的master_repl_offset 和slave_repl_offset
            - 看二者的接近程度
    - 从库ID号
        - 当优先级和复制进度都相同的情况下，ID号最小的从库得分最高，被选为新主库